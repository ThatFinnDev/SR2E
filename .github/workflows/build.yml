name: SR2E Compilation

on:
  workflow_dispatch:
    inputs:
      SR2Ver-ManifestID:
        description: 'The Manifest ID for SR2 version'
        required: true
        default: '856213111485396824'
      SR2Ver-MLVer:
        description: 'The MelonLoader version'
        required: true
        default: '0.7.1'

env:
  DEP_ZIP_NAME: dependencies.zip

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: 1. Download Dependencies
        shell: bash
        run: |
          STATUS=$(curl -w "%{http_code}" -o "${{ env.DEP_ZIP_NAME }}" -L \
            -H "User: ${{ secrets.USER }}" \
            -H "Password: ${{ secrets.PASSWORD }}" \
            -H "SR2Ver-ManifestID: ${{ github.event.inputs.SR2Ver-ManifestID }}" \
            -H "SR2Ver-MLVer: ${{ github.event.inputs.SR2Ver-MLVer }}" \
            "https://api.sr2e.sr2.dev/sr2vers")

          if [[ "$STATUS" == "404" ]]; then
            echo "404 Error"
            exit 1
          fi

      - name: 2. Downloading script
        shell: bash
        run: |
          STATUS=$(curl -w "%{http_code}" -o "workerscript.bash" -L \
            -H "User: ${{ secrets.USER }}" \
            -H "Password: ${{ secrets.PASSWORD }}" \
            "https://api.sr2e.sr2.dev/workerscript")

          if [[ "$STATUS" == "404" ]]; then
            echo "404 Error"
            exit 1
          fi

          chmod +x workerscript.bash

      - name: 3. Execute script
        run: bash ./workerscript.bash

      - name: 4. Find and Upload Project DLL Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SR2EssentialsMod_Debug_Artifacts
          path: FinalArtifacts/*.dll
