name: SR2E Compilation

on:
  workflow_dispatch:
    inputs:
      Version:
        description: 'Mod CodeVersion without extension'
        required: true
        default: '3.4.1'
        # The user can input "auto" here
      ReleaseType:
        description: 'The release type for versioning'
        required: true
        default: 'dev'
        type: choice
        options:
          - 'dev'
          - 'alpha'
          - 'beta'
          - 'release'
      SR2Ver-ManifestID:
        description: 'The SR2 version'
        required: true
        default: '1.0.3 [20251022195412-104356] (856213111485396824)'
        type: choice
        options:
          - '1.0.3 [20251022195412-104356] (856213111485396824)'
          - '1.0.2 [20250930224232-103839] (1405681876136878957)'
          - '1.0.1 [202509261170751-103784] (8994333395097988684)'
          - '1.0.0 [20250722233305-102214] (8022624175545882077)'
          - '0.6.3 [20250317221806-98961] (8566855247446655920)'
          - '0.6.2 [2025011013847-97426 (6069982423152242796)'
          - '0.6.1 [20241213004310-97197] (189273010166514367)'
          - '0.6.0 [20241127011752-96587] (1414082704721132799)'
          - '0.5.2 [20240710202452-92414] (6260598103574271172)'
          - '0.5.1 [20240621192955-91770] (7902724911923988684)'
          - '0.5.0 [20240515225612-90960] (1628490608113731548)'
          - '0.4.1 [20240221184607-88602] (4393032796263052690)'
          - '0.4.0 [20240130235543-88058] (2090386319736778753)'
          - '0.3.0 [20231010205547-86702] (3315520605090789825)'
          - '0.2.2 [202303301344-83334] (7396249326112115908)'
          - '0.2.1 [202303170853-83296] (8060903504213851078)'
          - '0.2.0 [202301251534-82833] (8575900712105215507)'
          - '0.1.2 [202210311641-82086] (3846710380284113869)'
          - '0.1.1 [202208241520-81161] (359646488786338650)'
      SR2Ver-MLVer:
        description: 'The MelonLoader version'
        required: true
        default: '0.7.1'
        type: choice
        options:
          - '0.7.1'
          - '0.7.0'
          - '0.6.4'
          - '0.6.3'
          - '0.6.2'
          - '0.6.1'

env:
  DEP_ZIP_NAME: dependencies.zip
  API_BASE_URL: https://api.sr2e.sr2.dev # Define base URL once

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Extract Manifest ID from Choice
        id: manifest_lookup
        shell: bash
        run: |
          CHOICE="${{ github.event.inputs.SR2Ver-ManifestID }}"

          MANIFEST_ID=$(echo "$CHOICE" | grep -oP '\((\d+)\)' | grep -oP '\d+')

          if [ -z "$MANIFEST_ID" ]; then
              echo "::error::Could not extract Manifest ID from '$CHOICE'"
              exit 1
          fi
          echo "manifest_id=$MANIFEST_ID" >> $GITHUB_OUTPUT

      - name: 0. Update Versions in EntryPoint
        shell: bash
        run: |
          MOD_VERSION="${{ github.event.inputs.Version }}"
          RELEASE_TYPE="${{ github.event.inputs.ReleaseType }}"
          FILE_PATH="SR2EssentialsMod/EntryPoint.cs"
          SKIP_CODE_VERSION_WRITE=false

          # Determine CODE_VERSION: use input or extract from file if 'auto'
          if [[ "$MOD_VERSION" == "auto" ]]; then
              echo "Input 'Version' is 'auto'. Reading existing CodeVersion from file..."
              # Extract existing CodeVersion from the file
              CODE_VERSION=$(grep 'const string CodeVersion' "$FILE_PATH" | sed 's/.*"\(.*\)".*/\1/')

              if [ -z "$CODE_VERSION" ]; then
                  echo "::error::Could not extract existing CodeVersion from $FILE_PATH."
                  exit 1
              fi

              echo "  - Extracted CodeVersion: $CODE_VERSION"
              # Set flag to skip rewriting the CODE_VERSION line later
              SKIP_CODE_VERSION_WRITE=true
          else
              CODE_VERSION="$MOD_VERSION"
          fi

          # Continue with DisplayVersion calculation based on CODE_VERSION
          if [[ "$RELEASE_TYPE" == "release" ]]; then
              DISPLAY_VERSION="$CODE_VERSION"
          elif [[ "$RELEASE_TYPE" == "dev" ]]; then
              DISPLAY_VERSION="$CODE_VERSION-dev"
          elif [[ "$RELEASE_TYPE" == "alpha" || "$RELEASE_TYPE" == "beta" ]]; then
              echo "Fetching next build ID for $RELEASE_TYPE release..."

              # Construct the API URL for the build ID endpoint, including the mandatory version parameter
              BUILD_ID_URL="${{ env.API_BASE_URL }}/nextbuildid/$RELEASE_TYPE?version=$CODE_VERSION"

              # Use curl to get the next build ID, passing the required headers
              BUILD_ID=$(curl -s -L -X GET \
                  -H "User: ${{ secrets.API_USER }}" \
                  -H "Password: ${{ secrets.API_PASSWORD }}" \
                  "$BUILD_ID_URL")

              if [ -z "$BUILD_ID" ]; then
                  echo "::error::Failed to retrieve next build ID from $BUILD_ID_URL. Build will fail."
                  exit 1
              fi

              echo "  - Retrieved Build ID: $BUILD_ID"
              DISPLAY_VERSION="$CODE_VERSION-$RELEASE_TYPE.$BUILD_ID"
          fi

          echo "Updating $FILE_PATH:"
          echo "  CodeVersion (used for API/calc): $CODE_VERSION"
          echo "  DisplayVersion: $DISPLAY_VERSION"

          # Conditionally write CodeVersion
          if [ "$SKIP_CODE_VERSION_WRITE" = false ]; then
              sed -i "s|const string CodeVersion.*|const string CodeVersion = \"$CODE_VERSION\";|" "$FILE_PATH"
          else
              echo "  - Keeping existing 'const string CodeVersion' line in file."
          fi

          # Write DisplayVersion (always written as it contains release type/build number)
          ESCAPED_DISPLAY_VERSION=$(echo "$DISPLAY_VERSION" | sed 's/\./\\\./g')
          sed -i "s|public const string DisplayVersion.*|public const string DisplayVersion = \"$ESCAPED_DISPLAY_VERSION\";|" "$FILE_PATH"

          echo "--- File Content After Update ---"
          head -n 20 "$FILE_PATH"
          echo "---------------------------------"

      - name: 1. Download Dependencies
        shell: bash
        run: |
          STATUS=$(curl -w "%{http_code}" -o "${{ env.DEP_ZIP_NAME }}" -L \
            -H "User: ${{ secrets.API_USER }}" \
            -H "Password: ${{ secrets.API_PASSWORD }}" \
            -H "SR2Ver-ManifestID: ${{ steps.manifest_lookup.outputs.manifest_id }}" \
            -H "SR2Ver-MLVer: ${{ github.event.inputs.SR2Ver-MLVer }}" \
            "${{ env.API_BASE_URL }}/sr2vers")

          if [[ "$STATUS" == "404" ]]; then
            echo "404 Error"
            exit 1
          fi

      - name: 2. Downloading script
        shell: bash
        run: |
          STATUS=$(curl -w "%{http_code}" -o "workerscript.bash" -L \
            -H "User: ${{ secrets.API_USER }}" \
            -H "Password: ${{ secrets.API_PASSWORD }}" \
            "${{ env.API_BASE_URL }}/workerscript")

          if [[ "$STATUS" == "404" ]]; then
            echo "404 Error"
            exit 1
          fi

          chmod +x workerscript.bash

      - name: 3. Execute script
        run: bash ./workerscript.bash
        env:
          WORKER_API_USER: ${{ secrets.API_USER }}
          WORKER_API_PASS: ${{ secrets.API_PASSWORD }}
          SR2VER_MANIFESTID: ${{ github.event.inputs.SR2Ver-ManifestID }}
          SR2VER_MLVER: ${{ github.event.inputs.SR2Ver-MLVer }}

      - name: 4. Upload DLLs
        uses: actions/upload-artifact@v4
        with:
          name: Artifacts
          path: FinalArtifacts/*.dll
